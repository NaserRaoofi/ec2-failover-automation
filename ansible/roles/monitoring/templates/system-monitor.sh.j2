#!/bin/bash
# System monitoring script for {{ project_name }}
# Generated by Ansible on {{ ansible_date_time.iso8601 }}

LOGFILE="/var/log/system-monitor.log"
TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')

# Function to log with timestamp
log_message() {
    echo "[$TIMESTAMP] $1" >> $LOGFILE
}

# Check system load
LOAD=$(uptime | awk -F'load average:' '{print $2}' | sed 's/^[ \t]*//')
log_message "System Load: $LOAD"

# Check memory usage
MEMORY=$(free | grep Mem | awk '{printf "%.1f%% used", $3/$2 * 100.0}')
log_message "Memory Usage: $MEMORY"

# Check disk usage
DISK=$(df -h / | awk 'NR==2{printf "%s used", $5}')
log_message "Disk Usage: $DISK"

# Check critical services
SERVICES=("httpd" "docker" "amazon-cloudwatch-agent" "amazon-ssm-agent")
for service in "${SERVICES[@]}"; do
    if systemctl is-active --quiet $service; then
        log_message "Service $service: RUNNING"
    else
        log_message "Service $service: STOPPED"
    fi
done

# Check network connectivity
if ping -c 1 8.8.8.8 >/dev/null 2>&1; then
    log_message "Network Connectivity: OK"
else
    log_message "Network Connectivity: FAILED"
fi

# Check if web server is responding
if curl -s http://localhost{{ health_check_endpoint }} >/dev/null; then
    log_message "Web Server Health Check: OK"
else
    log_message "Web Server Health Check: FAILED"
fi

log_message "Monitoring check completed"
